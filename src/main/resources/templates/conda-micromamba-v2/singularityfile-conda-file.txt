BootStrap: docker
From: {{mamba_image}}
Stage: build
%files
    {{wave_context_dir}}/conda.yml /scratch/conda.yml
%post
    micromamba install -y -n base -f /scratch/conda.yml
    {{base_packages}}
    micromamba env export --name base --explicit > environment.lock
    echo ">> CONDA_LOCK_START"
    cat environment.lock
    echo "<< CONDA_LOCK_END"
    tar czf /opt/conda.tar.gz -C /opt conda 2>/dev/null || true

Bootstrap: docker
From: {{base_image}}
Stage: final
%files from build
    /opt/conda.tar.gz /opt/conda.tar.gz
%post
    cd /opt
    tar xzf conda.tar.gz 2>/dev/null || true
    rm conda.tar.gz
%environment
    export MAMBA_ROOT_PREFIX=/opt/conda
    export PATH="$MAMBA_ROOT_PREFIX/bin:$PATH"
