BootStrap: docker
From: {{pixi_image}}
Stage: build
%files
    {{wave_context_dir}}/conda.yml /scratch/conda.yml
%post
    mkdir /opt/wave && cd /opt/wave
    pixi init --import /scratch/conda.yml
    {{base_packages}}
    pixi shell-hook > /shell-hook.sh
    echo 'exec "$@"' >> /shell-hook.sh
    echo ">> CONDA_LOCK_START"
    cat /opt/wave/pixi.lock
    echo "<< CONDA_LOCK_END"
    tar czf /opt/pixi-env.tar.gz -C /opt/wave/.pixi/envs default
    ls -lh /opt/pixi-env.tar.gz

Bootstrap: docker
From: {{base_image}}
Stage: final
# install binary from stage one
%files from build
    /opt/pixi-env.tar.gz /opt/pixi-env.tar.gz
    /shell-hook.sh /shell-hook.sh
%post
    mkdir -p /opt/wave/.pixi/envs
    tar xzf /opt/pixi-env.tar.gz -C /opt/wave/.pixi/envs
    rm /opt/pixi-env.tar.gz
%environment
    export PATH="$MAMBA_ROOT_PREFIX/bin:$PATH"
