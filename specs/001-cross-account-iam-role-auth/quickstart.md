# Quickstart: Cross-Account IAM Role Authentication for AWS ECR

## Overview

Wave supports cross-account ECR authentication using AWS STS AssumeRole. Instead of storing
static AWS access keys, customers provide an **IAM Role ARN** and an **External ID**. Wave
assumes the role using its own AWS identity to obtain temporary credentials, then authenticates
to the customer's ECR registry.

### Key Concepts

| Concept | Description |
|---------|-------------|
| **Role ARN** | The ARN of the IAM role in the customer's AWS account that Wave will assume. Format: `arn:aws:iam::<ACCOUNT_ID>:role/<ROLE_NAME>` |
| **External ID** | A shared secret (UUID) generated by Seqera Platform. The customer configures it in their role's trust policy. Prevents the [confused deputy problem](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_create_for-user_externalid.html). |
| **Wave's Service Identity** | The AWS IAM user/role that Wave runs as. This identity performs the `sts:AssumeRole` call. In dev: `DevelopmentTowerUser`. |

### How It Works

```
Customer stores role ARN + external ID in Tower
         |
Wave receives container request with Tower access token
         |
Wave fetches credentials from Tower API
         |
Tower returns: { assumeRoleArn: "arn:...", externalId: "uuid-..." }
         |
Wave detects role ARN pattern (arn:aws:iam::\d{12}:role/.+)
         |
Wave calls STS AssumeRole using its own AWS identity
  - roleArn: customer's role
  - externalId: from Tower credentials
  - durationSeconds: 3600 (1 hour)
         |
STS validates trust policy + external ID → returns temp credentials
         |
Wave uses temp credentials to call ECR GetAuthorizationToken
         |
ECR token cached with TTL = (STS expiration - 5 min buffer)
```

---

## Prerequisites

- Java 21+
- AWS CLI configured (`aws configure`)
- Access to **two AWS accounts**:
  - **Wave account** (where Wave runs) — e.g. account `128997144437`
  - **Customer account** (where ECR lives) — e.g. account `924133642166`
- A running Seqera Platform (Tower) instance (credentials are stored in Tower)

---

## Setup

### Step 1: Build Wave

```bash
git checkout 001-cross-account-iam-role-auth
./gradlew assemble
./gradlew test
```

### Step 2: Configure Wave's AWS Identity

Wave needs AWS credentials to make the STS AssumeRole call. These are Wave's **own** credentials,
not the customer's.

```bash
# Option A: environment variables
export AWS_ACCESS_KEY_ID=AKIA...        # Wave's access key
export AWS_SECRET_ACCESS_KEY=wJalrX...  # Wave's secret key
export AWS_REGION=eu-west-1

# Option B: AWS CLI profile
export AWS_PROFILE=wave-dev
export AWS_REGION=eu-west-1
```

Verify:
```bash
aws sts get-caller-identity
# Should show Wave's identity, e.g.:
# "Arn": "arn:aws:iam::128997144437:user/DevelopmentTowerUser"
```

### Step 3: Create IAM Role in Customer Account

This is done in the **customer's AWS account** (the account with the ECR registry).

#### 3a. Create the trust policy

Replace `WAVE_ACCOUNT_ID` with Wave's AWS account ID and `EXTERNAL_ID` with a UUID:

```bash
cat > trust-policy.json <<'EOF'
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "AWS": "arn:aws:iam::WAVE_ACCOUNT_ID:user/DevelopmentTowerUser"
      },
      "Action": "sts:AssumeRole",
      "Condition": {
        "StringEquals": {
          "sts:ExternalId": "EXTERNAL_ID"
        }
      }
    }
  ]
}
EOF

# Create the role
aws iam create-role \
  --role-name WaveEcrAccess \
  --assume-role-policy-document file://trust-policy.json \
  --profile <customer-account-profile>
```

#### 3b. Attach ECR permissions to the role

```bash
cat > ecr-policy.json <<'EOF'
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "ECRAuthToken",
      "Effect": "Allow",
      "Action": "ecr:GetAuthorizationToken",
      "Resource": "*"
    },
    {
      "Sid": "ECRPull",
      "Effect": "Allow",
      "Action": [
        "ecr:BatchCheckLayerAvailability",
        "ecr:GetDownloadUrlForLayer",
        "ecr:BatchGetImage",
        "ecr:DescribeImages",
        "ecr:ListImages"
      ],
      "Resource": "arn:aws:ecr:*:CUSTOMER_ACCOUNT_ID:repository/*"
    }
  ]
}
EOF

aws iam put-role-policy \
  --role-name WaveEcrAccess \
  --policy-name EcrReadAccess \
  --policy-document file://ecr-policy.json \
  --profile <customer-account-profile>
```

### Step 4: Grant Wave Permission to Assume the Role

In the **Wave account**, give Wave's identity permission to call `sts:AssumeRole`:

```bash
cat > assume-policy.json <<'EOF'
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": "sts:AssumeRole",
      "Resource": "arn:aws:iam::CUSTOMER_ACCOUNT_ID:role/WaveEcrAccess"
    }
  ]
}
EOF

aws iam put-user-policy \
  --user-name DevelopmentTowerUser \
  --policy-name AssumeCustomerRole \
  --policy-document file://assume-policy.json \
  --profile <wave-account-profile>
```

### Step 5: Verify the IAM Setup

Before involving Wave, test the AssumeRole call directly:

```bash
aws sts assume-role \
  --role-arn "arn:aws:iam::CUSTOMER_ACCOUNT_ID:role/WaveEcrAccess" \
  --role-session-name "wave-test" \
  --external-id "EXTERNAL_ID"
```

If this returns `AccessKeyId`, `SecretAccessKey`, and `SessionToken`, the IAM setup is correct.

---

## Running Wave with Role-Based Auth

### Step 1: Register Credentials in Tower

Credentials are **not passed directly to Wave**. They must be stored in Tower first:

```bash
curl -X POST "https://<tower-url>/api/credentials?workspaceId=<WORKSPACE_ID>" \
  -H "Authorization: Bearer <TOWER_TOKEN>" \
  -H "Content-Type: application/json" \
  -d '{
    "credentials": {
      "name": "my-ecr-cross-account",
      "provider": "aws",
      "keys": {
        "assumeRoleArn": "arn:aws:iam::CUSTOMER_ACCOUNT_ID:role/WaveEcrAccess",
        "externalId": "EXTERNAL_ID"
      }
    }
  }'
```

Tower stores `assumeRoleArn` and `externalId` and will return them to Wave when requested.

### Step 2: Start Wave

```bash
./run.sh
```

### Step 3: Send a Container Request

```bash
curl -X POST "http://localhost:9090/v1alpha2/container" \
  -H "Content-Type: application/json" \
  -d '{
    "containerImage": "CUSTOMER_ACCOUNT_ID.dkr.ecr.eu-west-1.amazonaws.com/my-image:latest",
    "towerAccessToken": "<TOWER_TOKEN>",
    "towerWorkspaceId": <WORKSPACE_ID>,
    "towerEndpoint": "https://<tower-url>"
  }'
```

### Step 4: Watch the Logs

The local config has TRACE logging enabled for `io.seqera.wave.service.aws`:

```bash
tail -f wave.log | grep -iE 'assume|role|ecr|sts|cache'
```

Expected log sequence:
```
DEBUG AwsEcrService - Getting ECR login token with role assumption - roleArn=arn:aws:iam::...; region=eu-west-1
TRACE AwsEcrService - Cache miss for role arn:aws:iam::... - assuming role to get temporary credentials
TRACE AwsEcrService - Assuming AWS role: arn:aws:iam::...; region: eu-west-1; externalId: provided
DEBUG AwsEcrService - Getting AWS ECR auth token - region=eu-west-1; accessKey=ASIA...; sessionToken=present
```

### Using the Test Script

Alternatively, use the provided test script:

```bash
export TOWER_ACCESS_TOKEN="<your-token>"
export TOWER_WORKSPACE_ID="<workspace-id>"
export AWS_ROLE_ARN="arn:aws:iam::CUSTOMER_ACCOUNT_ID:role/WaveEcrAccess"
export AWS_EXTERNAL_ID="EXTERNAL_ID"
export ECR_REGISTRY="CUSTOMER_ACCOUNT_ID.dkr.ecr.eu-west-1.amazonaws.com"
bash test-assume-role.sh
```

---

## Credential Caching

Role-based credentials are cached with a TTL derived from the STS credential expiration:

- **Cache TTL** = `min(STS_expiration - 5min, wave.aws.ecr.cache.duration)`
- **5-minute buffer** ensures credentials are refreshed before they expire
- **Minimum TTL** of 1 minute prevents caching nearly-expired credentials
- Default STS session: 1 hour → effective cache TTL: ~55 minutes

Configuration in `application.yml`:
```yaml
wave:
  aws:
    ecr:
      cache:
        duration: 3h     # max cache duration (role TTL will be shorter)
        max-size: 10000  # max cached entries
```

---

## Backward Compatibility

Static AWS credentials (access key + secret key) continue to work unchanged. Wave auto-detects
the credential type by matching the username against the IAM role ARN pattern
`arn:aws:iam::\d{12}:role/.+`:

| Username | Detected As | Auth Flow |
|----------|-------------|-----------|
| `AKIAIOSFODNN7EXAMPLE` | Static credentials | Direct ECR auth |
| `arn:aws:iam::123456789012:role/MyRole` | IAM Role ARN | STS AssumeRole → ECR auth |

---

## Troubleshooting

### "User is not authorized to perform: sts:AssumeRole"

Both sides of the trust must be configured:

1. **Wave's identity** needs `sts:AssumeRole` permission on the customer role (Step 4 above)
2. **Customer's role** trust policy must list Wave's identity as Principal (Step 3a above)
3. **External ID** must match between Tower credentials and the role's trust policy

Verify with:
```bash
# Check what identity Wave is running as
aws sts get-caller-identity

# Check the role's trust policy
aws iam get-role --role-name WaveEcrAccess \
  --query 'Role.AssumeRolePolicyDocument' \
  --profile <customer-account-profile>

# Test the assume role call directly
aws sts assume-role \
  --role-arn "arn:aws:iam::CUSTOMER_ACCOUNT_ID:role/WaveEcrAccess" \
  --role-session-name "test" \
  --external-id "EXTERNAL_ID"
```

### "STS is not enabled in the specified region"

Enable the STS regional endpoint in the AWS console, or use `us-east-1` (global endpoint is always enabled).

### Credentials expire during a build

The 5-minute refresh buffer should prevent this. If it still happens:
- Check for clock skew: `date` vs NTP
- Reduce `durationSeconds` in `assumeRole` and verify the buffer logic triggers

---

## References

- [AWS IAM Roles - External ID](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_create_for-user_externalid.html)
- [AWS STS AssumeRole API](https://docs.aws.amazon.com/STS/latest/APIReference/API_AssumeRole.html)
- [ECR Authentication](https://docs.aws.amazon.com/AmazonECR/latest/userguide/registry_auth.html)
- [Confused Deputy Problem](https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html)